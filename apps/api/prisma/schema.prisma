generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// ==================== USER MODELS ====================

model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  displayName         String?
  avatarUrl           String?
  subscriptionTier    String   @default("free") // free, monthly, annual
  subscriptionStatus  String   @default("active") // active, canceled, expired, trial
  onboardingCompleted Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  preferences   UserPreferences?
  onboardingData OnboardingData?
  tasks         Task[]
  conversations Conversation[]
  documents     Document[]

  @@map("users")
}

model UserPreferences {
  id                   String   @id @default(uuid())
  userId               String   @unique
  notificationsEnabled Boolean  @default(true)
  reminderTime         String   @default("09:00") // HH:MM format
  reminderDays         String   @default("1,3,5") // Comma-separated day numbers (0-6)
  theme                String   @default("system") // light, dark, system
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model OnboardingData {
  id             String   @id @default(uuid())
  userId         String   @unique
  lifeStage      String?
  financialGoals String?  // JSON array stored as string
  painPoints     String?  // JSON array stored as string
  hasPartner     Boolean?
  hasDependents  Boolean?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("onboarding_data")
}

// ==================== TASK MODELS ====================

model Task {
  id               String    @id @default(uuid())
  userId           String
  templateId       String?
  title            String
  description      String?
  category         String    // credit_score, retirement, insurance, etc.
  priority         String    @default("medium") // low, medium, high, urgent
  status           String    @default("pending") // pending, in_progress, completed, skipped, snoozed
  dueDate          DateTime?
  completedAt      DateTime?
  recurrence       String?   // JSON object stored as string
  estimatedMinutes Int?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  template       TaskTemplate?       @relation(fields: [templateId], references: [id])
  completionLogs TaskCompletionLog[]

  @@index([userId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

model TaskTemplate {
  id                String   @id @default(uuid())
  title             String
  description       String
  category          String
  defaultPriority   String   @default("medium")
  defaultRecurrence String?  // JSON object stored as string
  estimatedMinutes  Int
  helpContent       String?
  whyItMatters      String?
  lifeStageTags     String?  // JSON array stored as string
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  tasks Task[]

  @@map("task_templates")
}

model TaskCompletionLog {
  id               String   @id @default(uuid())
  taskId           String
  userId           String
  completedAt      DateTime @default(now())
  timeSpentMinutes Int?
  notes            String?
  outcome          String   // completed_successfully, completed_with_issues, needs_followup, deferred

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@map("task_completion_logs")
}

// ==================== CHAT MODELS ====================

model Conversation {
  id        String   @id @default(uuid())
  userId    String
  title     String?
  context   String   @default("general") // general, task_help, document_review, financial_question, emotional_support
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([userId])
  @@map("conversations")
}

model ChatMessage {
  id             String   @id @default(uuid())
  conversationId String
  role           String   // user, assistant, system
  content        String
  metadata       String?  // JSON object stored as string
  createdAt      DateTime @default(now())

  // Relations
  conversation Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  attachments  ChatAttachment[]

  @@index([conversationId])
  @@map("chat_messages")
}

model ChatAttachment {
  id             String   @id @default(uuid())
  messageId      String
  type           String   // image, pdf, document
  url            String
  filename       String
  mimeType       String
  sizeBytes      Int
  analysisResult String?  // JSON object stored as string
  createdAt      DateTime @default(now())

  // Relations
  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("chat_attachments")
}

// ==================== DOCUMENT MODELS ====================

model Document {
  id           String   @id @default(uuid())
  userId       String
  filename     String
  mimeType     String
  sizeBytes    Int
  blobUrl      String
  documentType String?  // bank_statement, credit_card_statement, tax_document, etc.
  extractedData String? // JSON object stored as string
  summary       String?
  isProcessed   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("documents")
}
